<?xml version="1.0" standalone="no"?>


<kickstart>

  <description>

Generates x509 certificates for nodes.

  </description>

        <copyright>
        Copyright (c) 2000 - 2008 The Regents of the University of California.
        All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
        </copyright>

  <changelog>
  $Log: cert.xml,v $
  Revision 1.5  2009/01/23 23:19:31  mjk
  tweaks on the entities

  Revision 1.4  2008/10/18 00:55:45  mjk
  copyright 5.1

  Revision 1.3  2008/03/06 23:41:30  mjk
  copyright storm on

  Revision 1.2  2007/06/23 04:03:18  mjk
  mars hill copyright

  Revision 1.1  2005/03/01 00:22:26  mjk
  moved to base roll

  Revision 1.7  2005/02/15 22:58:52  mjk
  dtd is gone

  Revision 1.6  2004/08/20 23:45:26  fds
  Simpler. Get a new kickstart cert every time.

  Revision 1.5  2004/08/18 20:47:47  fds
  Give nodes a copy of our CA cert so they can verify us in the future.

  Revision 1.4  2004/07/28 23:18:33  fds
  Tweaks

  Revision 1.3  2004/07/07 18:42:04  fds
  Better DN handling (no 64-char limits) using tricks from Dr Stephen Henson.
  Note external certs do not record an IP address.

  Revision 1.2  2004/07/01 00:08:21  fds
  Security, and new rocks-dist structure.

  Revision 1.1  2004/06/29 22:30:57  fds
  Putting apache conf files in conf.d where they are automatically
  included.

  </changelog>


<post>

<eval shell="bash" mode="xml">

# Make a Cert Request and keypair.

cert=`mktemp -dq /etc/security/ca/new-certs/cert.XXXXXX`

(
cd /etc/security/ca; \
/usr/bin/openssl req -new -nodes -config ca.cfg \
        -keyout $cert/key \
        -subj "\
/C=$Info_CertificateCountry/\
ST=$Info_CertificateState/\
L=$Info_CertificateLocality/\
O=$Info_CertificateOrganization/\
OU=$Info_ClusterName/\
CN=&hostname;/\
CN=RocksMembership:&membership;/\
CN=RocksPrivateAddress:&hostaddr;" \
        &gt; $cert/csr 2&gt;/dev/null 
)

echo "&lt;file name='/etc/security/cluster-cert.key' perms='0400'&gt;"
cat $cert/key
echo "&lt;/file&gt;"


# Sign the Cert with our CA.

(
cd /etc/security/ca; \
/usr/bin/openssl x509 -req -days 1000 \
        -CA ca.crt -CAkey ca.key -CAserial ca.serial \
        &lt; $cert/csr \
        &gt; $cert/crt 2&gt;/dev/null
)

echo "&lt;file name='/etc/security/cluster-cert.crt' perms='0444'&gt;"
cat $cert/crt
echo "&lt;/file&gt;"

rm -rf $cert

</eval>

<file name="/etc/security/cluster-ca.crt" perms='0444'>
<eval>
cat /etc/security/ca/ca.crt
</eval>
</file>

</post>

</kickstart>
