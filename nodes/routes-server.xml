<?xml version="1.0" standalone="no"?>

<kickstart>

  <description>

	Set up static routes on server

  </description>

        <copyright>
        Copyright (c) 2000 - 2008 The Regents of the University of California.
        All rights reserved. Rocks(r) v5.0 www.rocksclusters.org
        </copyright>

  <changelog>
  $Log: routes-server.xml,v $
  Revision 1.11  2008/03/06 23:41:30  mjk
  copyright storm on

  Revision 1.10  2007/07/03 23:06:24  phil
  one missing fi can ruin your whole cluster

  Revision 1.9  2007/07/03 22:34:30  phil
  Try to really generate the static routes on the server

  Revision 1.8  2007/07/03 22:27:47  phil
  Properly call mysql with user apache

  Revision 1.7  2007/07/03 19:11:27  phil
  update routes as apache -- should really be a rocks command.
  Use rocks list host interface to get the set of network interfaces instead of
  a direct mysql  call

  Revision 1.6  2007/06/23 04:03:18  mjk
  mars hill copyright

  Revision 1.5  2005/11/02 20:10:09  phil
  Always contact the frontend through the private interface.

  Revision 1.4  2005/09/27 22:55:06  bruno
  use the 'var' tag to get the name of the frontend

  Revision 1.3  2005/09/26 23:55:00  mjk
  fix static routes on frontend (maybe)

  Revision 1.2  2005/09/22 04:08:18  phil
  correct database for mysql access

  Revision 1.1  2005/09/22 03:19:32  phil
  Populate database with static-routing information
  Create static-routes file from database

  </changelog>

<post>

<!-- Add Multicast Routes to Database, And static route to frontend -->
<!-- XXX: This should be a rocks command -->
<file name="/tmp/routes.sql">
insert into routes(Network, Netmask, Gateway, Device) values("224.0.0.0", 4, NULL, "eth0");
insert into routes(Network, Netmask, Gateway, Device) values("255.255.255.255", 32, NULL, "eth0");
insert into routes(Network, Netmask, Gateway) values("<var name="Kickstart_PublicAddress"/>", 32, "<var name="Kickstart_PrivateAddress"/>");
</file>

if [ -f "/root/.my.cnf" ]; then
	clupass=`/bin/awk -F= '/password/{print $2}' /root/.my.cnf`
fi

if [ "x$clupass" != "x" ]; then 
	/usr/bin/mysql -u apache -p$clupass cluster &lt; /tmp/routes.sql
else
	/usr/bin/mysql cluster &lt; /tmp/routes.sql
fi


<file name="/etc/sysconfig/static-routes"/> 
/opt/rocks/bin/dbreport static-routes <var name="Kickstart_PrivateHostname"/> &gt;&gt; /etc/sysconfig/static-routes

</post>

</kickstart> 
